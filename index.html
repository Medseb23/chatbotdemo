<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat RAG On-Prem</title>
  <style>
    body{font-family:system-ui;margin:40px;max-width:900px}
    textarea{width:100%;height:120px;padding:10px;font-size:16px}
    button{padding:10px 16px;font-size:16px;cursor:pointer}
    .box{white-space:pre-wrap;border:1px solid #ddd;padding:12px;border-radius:8px;background:#fafafa;margin-top:12px}
    .meta{color:#666;font-size:14px;margin-top:6px}
  </style>
</head>
<body>
  <h1>Chat RAG On-Prem</h1>
  <p>Consulta basado <b>solo</b> en nuestros documentos.</p>

  <label>Pregunta</label>
  <textarea id="q" placeholder="Ej: ¿Cuáles son las competencias de liderazgo?"></textarea><br>
  <button id="ask">Preguntar</button>

  <div id="out" class="box" style="display:none"></div>
  <div id="meta" class="meta"></div>

<script>
  // ⚠️ Cambia esto a tu URL pública del túnel (https)
  const API_URL = "https://lakes-might-collapse-tests.trycloudflare.com"; // o ngrok

  async function ask(){
    const q = document.getElementById('q').value.trim();
    if(!q) return;
    const out = document.getElementById('out');
    const meta = document.getElementById('meta');
    out.style.display = 'block';
    out.textContent = "Consultando...";
    meta.textContent = "";

    try{
      const r = await fetch(`${API_URL}/api/ask`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ question: q })
      });
      const data = await r.json();
      if(!r.ok){
        out.textContent = `Error: ${data.error || r.status}`;
        meta.textContent = data.detail ? `detail: ${data.detail}` : "";
        return;
      }
      const cites = (data.citations||[]).map(c=>`(#${c.idx} ${c.source}${c.page?(' p.'+c.page):''})`).join(' ');
      out.textContent = data.answer || '';
      meta.textContent = `Citas: ${cites || '—'} | Chunks: ${data.retrieved_final ?? data.retrieved || 0}`;
    }catch(e){
      out.textContent = "Error de red: " + e;
    }
  }
  document.getElementById('ask').onclick = ask;
</script>
</body>
</html>
