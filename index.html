<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STREET ‚Ä¢ RAG ‚Ä¢ II</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      --arcade-yellow:#F8E71C;--arcade-orange:#F5A623;--arcade-red:#D0021B;
      --arcade-blue:#4A90E2;--arcade-cyan:#50E3C2;--text:#e6f0ff;
      --panel:#0d0f1a;--panel-2:#12152a;--scanline:rgba(255,255,255,.06);
      --glass:rgba(8,10,28,.70);--glass-2:rgba(14,18,44,.75);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:'Press Start 2P',system-ui,monospace; letter-spacing:.4px;
      background:
        radial-gradient(1200px 600px at 50% -20%, rgba(0,0,0,.35) 0%, rgba(0,0,0,.75) 60%, rgba(0,0,0,.95) 100%),
        url("./sf2background.jpg") center / cover fixed no-repeat;
      display:grid; place-items:center; overflow-x:hidden;
    }
    /* Vignette + scanlines CRT (se aten√∫a en m√≥viles) */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(120% 140% at 50% 50%, transparent 60%, rgba(0,0,0,.55) 100%),
        repeating-linear-gradient(to bottom, var(--scanline) 0 2px, transparent 2px 4px);
      mix-blend-mode:overlay; opacity:.9;
    }

    .wrap{ width:min(1100px,92vw); margin:auto; display:grid; gap:14px; }
    .cabecera{ text-align:center; margin-bottom:6px; text-shadow:0 0 10px #ffd966, 0 0 20px #ff7a00; }
    .logo{ font-size: clamp(20px,3.8vw,40px); margin:8px 0 4px; color: var(--arcade-yellow); transform:skew(-6deg); letter-spacing:1.2px; }
    .blink{ animation: blink 1s steps(1) infinite; }
    @keyframes blink{ 50%{opacity:0} }
    .sub{ font-size:10px; opacity:.85; }

    .versus{
      position:relative; z-index:2;
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:14px;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.6));
    }
    .fighter{
      background: linear-gradient(180deg, var(--glass) 0, var(--glass-2) 100%);
      border: 2px solid #2b3370; border-radius:16px; padding:14px;
      display:grid; grid-template-columns:64px 1fr; gap:12px;
      box-shadow: 0 0 0 3px rgba(0,0,0,.75) inset; backdrop-filter: blur(2px) saturate(120%);
      min-width:0;
    }
    .avatar{ width:64px; height:64px; border-radius:10px; overflow:hidden; border:2px solid #5f6bd3;
      display:grid; place-items:center; background:linear-gradient(145deg,#2b2f61,#15183a); font-size:22px; }
    .stats{ display:grid; gap:6px }
    .tag{ font-size:10px; color:var(--arcade-cyan) }
    .name{ font-size:13px; color:var(--arcade-yellow) }
    .bar{ height:10px; background:#15193a; border:2px solid #2b3370; border-radius:6px; overflow:hidden }
    .bar>i{ display:block; height:100%; background: linear-gradient(90deg,#33ebff,#4bff87) }
    .vs{ font-size: clamp(18px,4.2vw,40px); color: var(--arcade-red); text-shadow: 0 0 6px #fff, 0 0 18px var(--arcade-red); transform: skew(-10deg) translateY(-2px); }

    .panel{
      background: linear-gradient(180deg, rgba(10,12,28,.94), rgba(6,8,18,.94));
      border: 2px solid #2b3370; border-radius:16px; padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55), 0 0 0 3px rgba(0,0,0,.7) inset;
      position:relative; z-index:1; overflow:hidden;
    }
    .panel::after{
      content:""; position:absolute; left:0; right:0; top:-40px; height:80px;
      background: radial-gradient(600px 60px at 50% 100%, rgba(255,229,77,.35), transparent 70%);
      pointer-events:none; filter: blur(12px);
    }

    .input-row{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:stretch }
    textarea{
      width:100%; min-height:110px; resize:vertical; background:#0c0f21; color:var(--text);
      border:2px solid #3b417a; border-radius:12px; padding:12px; font-family:inherit; font-size:12px; line-height:1.5;
      outline:none; box-shadow: inset 0 0 0 2px #000;
    }
    textarea:focus{ border-color:var(--arcade-blue); box-shadow:0 0 0 3px rgba(80,227,194,.2) }

    .btn{
      font-family:inherit; font-weight:700; letter-spacing:.6px; font-size:12px; padding:14px 18px; border-radius:12px;
      background: linear-gradient(180deg,#ffcf33,#f77f00); color:#000; border:0; cursor:pointer;
      box-shadow: 0 6px 0 #8c3b00, 0 12px 22px rgba(0,0,0,.45); transition:.15s; transform: translateY(0);
      touch-action: manipulation;
    }
    .btn:hover{ filter: brightness(1.06) }
    .btn:active{ transform: translateY(2px); box-shadow: 0 4px 0 #8c3b00, 0 6px 16px rgba(0,0,0,.45) }

    .advanced-toggle{ margin-top:8px; font-size:11px; color:#9fb0ff; cursor:pointer; text-decoration:underline }
    .advanced{ display:none; margin-top:8px }
    .grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px }
    .field{ background:#0a0d1e; border:1px solid #2a2f55; padding:8px; border-radius:10px; font-size:11px }
    .field label{ display:block; margin-bottom:4px; color:#a4b3ff }
    .field input{ width:100%; background:#060816; color:var(--text); border:1px solid #394080; border-radius:8px; padding:6px 8px; font-family:inherit; font-size:11px }

    .dialog{
      margin-top:12px; position:relative; background:#0b0e20; border:2px solid #2a2f55; border-radius:12px; padding:12px 12px 14px;
      box-shadow: 0 0 0 2px #000 inset;
    }
    .dialog::before{
      content:""; position:absolute; left:22px; top:-10px; width:16px; height:16px; background:#0b0e20;
      border-left:2px solid #2a2f55; border-top:2px solid #2a2f55; transform:rotate(45deg);
    }
    .who{ display:flex; align-items:center; gap:10px; margin-bottom:8px; font-size:12px; color: var(--arcade-cyan) }
    .who .p{ width:26px; height:26px; border-radius:6px; background:#182052; display:grid; place-items:center; border:1px solid #3950c6 }
    .txt{ font-size:12px; line-height:1.6; min-height:32px }
    .meta{ margin-top:10px; display:flex; flex-wrap:wrap; gap:6px 12px; font-size:10px; opacity:.85 }
    .pill{ background:#0a0d1e; padding:6px 8px; border-radius:999px; border:1px solid #2a2f55 }
    .cites{ margin-top:10px; font-size:11px }
    .cites a{ color: var(--arcade-yellow); text-decoration: underline }

    .footer{ margin:14px auto 8px; text-align:center; font-size:10px; opacity:.7 }

    /* ======================
       RESPONSIVE (M√ìVIL)
       ====================== */
    @media (max-width: 680px){
      body{ letter-spacing:.2px; }
      body::before{ opacity:.55; } /* menos scanlines en m√≥vil */

      .wrap{ width:min(640px, 94vw); gap:10px; }
      .logo{ font-size: clamp(18px,6vw,28px); }
      .sub{ font-size:9px; }

      .versus{
        grid-template-columns: 1fr; /* apilado */
        gap:10px;
      }
      .vs{
        justify-self:center;
        transform: skew(-8deg);
        font-size: clamp(18px,7vw,28px);
      }
      .fighter{
        grid-template-columns:48px 1fr;
        padding:10px; border-radius:14px;
      }
      .avatar{ width:48px; height:48px; font-size:18px; }
      .name{ font-size:12px; }
      .tag{ font-size:9px; }
      .bar{ height:8px; }

      .panel{ padding:12px; border-radius:14px; }
      .panel::after{ height:60px; top:-30px; filter: blur(10px); }

      .input-row{
        grid-template-columns:1fr;   /* textarea arriba, bot√≥n abajo */
      }
      textarea{
        min-height: 140px; font-size: 11px; border-radius: 10px; padding: 10px;
      }
      .btn{
        width:100%; padding:14px; font-size:12px; border-radius: 10px;
      }

      .advanced-toggle{ font-size:10px; }
      .grid-2{ grid-template-columns: 1fr; } /* opciones en una columna */
      .field{ font-size:10px; }

      .dialog{ padding:10px; border-radius:10px; }
      .who{ font-size:11px; }
      .txt{ font-size:11px; }
      .meta{ font-size:9px; }
      .footer{ font-size:9px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="cabecera">
      <div class="logo">STREET ‚Ä¢ RAG ‚Ä¢ II <span class="blink">_</span></div>
      <div class="sub">IA Especializada en Street Fighter 2 ‚Ä¢ Consulta!</div>
    </header>

    <section class="versus">
      <div class="fighter">
        <div class="avatar">üßë‚Äçüíª</div>
        <div class="stats">
          <div class="tag">Player</div>
          <div class="name">Sebasti√°n</div>
          <div class="bar"><i style="width:88%"></i></div>
        </div>
      </div>
      <div class="vs">VS</div>
      <div class="fighter">
        <div class="avatar">ü§ñ</div>
        <div class="stats">
          <div class="tag">Challenger</div>
          <div class="name">RAG Engine</div>
          <div class="bar"><i style="width:100%"></i></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="input-row">
        <textarea id="q" placeholder="Escribe tu consulta‚Ä¶ (Ctrl/Cmd + Enter para enviar)" spellcheck="false"></textarea>
        <button id="askBtn" class="btn">HADOUKEN!</button>
      </div>

      <div class="advanced-toggle" id="advToggle">Opciones avanzadas</div>
      <div class="advanced" id="adv">
        <div class="grid-2">
          <div class="field"><label>Endpoint (HTTPS)</label><input id="endpoint" type="text" value="https://narrow-stuff-same-rebate.trycloudflare.com/api/ask"/></div>
          <div class="field"><label>max_tokens</label><input id="max_tokens" type="number" min="64" max="4096" step="16" value="1000"/></div>
          <div class="field"><label>temperature</label><input id="temperature" type="number" min="0" max="2" step="0.01" value="0.15"/></div>
          <div class="field"><label>top_p</label><input id="top_p" type="number" min="0" max="1" step="0.01" value="0.9"/></div>
          <div class="field"><label>repeat_penalty</label><input id="repeat_penalty" type="number" min="0.8" max="2" step="0.01" value="1.07"/></div>
          <div class="field"><label>initial_top_n</label><input id="initial_top_n" type="number" min="1" max="50" step="1" value="16"/></div>
          <div class="field"><label>top_k</label><input id="top_k" type="number" min="1" max="10" step="1" value="6"/></div>
          <div class="field"><label>threshold</label><input id="threshold" type="number" min="0" max="1" step="0.01" value="0.30"/></div>
          <div class="field"><label>mmr_lambda</label><input id="mmr_lambda" type="number" min="0" max="1" step="0.01" value="0.7"/></div>
        </div>
      </div>

      <div class="dialog" id="dialog">
        <div class="who"><div class="p">ü§ñ</div><div>RAG Engine</div></div>
        <div class="txt" id="answer">Escribe una consulta y presiona <b>HADOUKEN!</b></div>
        <div class="meta" id="meta"></div>
        <div class="cites" id="cites"></div>
      </div>
    </section>

    <footer class="footer">¬© 2025 ‚Äì Prototipo por PWR Solutions Chile ‚Ä¢ Versi√≥n Experimental de IA OnPremise</footer>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const q = $('#q'); const askBtn = $('#askBtn'); const advToggle = $('#advToggle'); const adv = $('#adv');
    const endpoint = $('#endpoint'); const ans = $('#answer'); const meta = $('#meta'); const cites = $('#cites');

    advToggle.addEventListener('click', ()=>{ adv.style.display = adv.style.display==='block' ? 'none' : 'block'; });

    async function typewriter(el, text, speed=12){
      el.innerHTML=''; for(let i=0;i<text.length;i++){ el.innerHTML += text[i]==='\n' ? '<br/>' : text[i]; await new Promise(r=>setTimeout(r,speed)); }
    }

    async function ask(){
      const ep = endpoint.value.trim(); const question = q.value.trim();
      if(!question){ q.focus(); return; }
      askBtn.disabled = true; askBtn.textContent='CARGANDO‚Ä¶'; meta.innerHTML=''; cites.innerHTML='';
      await typewriter(ans,'Invocando al maestro RAG‚Ä¶');

      try{
        const payload = {
          question,
          initial_top_n: Number($('#initial_top_n').value),
          top_k: Number($('#top_k').value),
          threshold: Number($('#threshold').value),
          mmr_lambda: Number($('#mmr_lambda').value),
          temperature: Number($('#temperature').value),
          max_tokens: Number($('#max_tokens').value),
          top_p: Number($('#top_p').value),
          repeat_penalty: Number($('#repeat_penalty').value),
          style: "concise",
          stream: false
        };

        const r = await fetch(ep,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!r.ok){ throw new Error('HTTP '+r.status+' ‚Äî '+await r.text()); }
        const data = await r.json();

        const answer = (data.answer||'').trim();
        await typewriter(ans, answer || 'Sin respuesta.');

        const p = data.params_used || {};
        meta.innerHTML = [
          ['initial_top_n',p.initial_top_n],['top_k',p.top_k],['threshold',p.threshold],['mmr_lambda',p.mmr_lambda],
          ['temperature',p.temperature],['top_p',p.top_p],['repeat_penalty',p.repeat_penalty],['max_tokens',p.max_tokens]
        ].filter(x=>x[1]!==undefined).map(([k,v])=>`<span class="pill">${k}: <b>${v}</b></span>`).join('');

        const citz = (data.citations||[]);
        if(citz.length){
          cites.innerHTML = '<b>Fuentes:</b> ' + citz.map(c=>{
            const label = `[#${c.idx}] ${c.source}${c.page ? ' p.'+c.page : ''}`;
            const isUrl = /^https?:\/\//i.test(c.source||'');
            return isUrl ? `<a href="${c.source}" target="_blank" rel="noopener">${label}</a>` : `<span>${label}</span>`;
          }).join(' ¬∑ ');
        }

        if (data.truncated) {
          const more = document.createElement('button');
          more.className = 'btn'; more.style.marginTop = '10px'; more.textContent = 'VER M√ÅS';
          more.onclick = async ()=>{
            more.disabled = true; more.textContent = 'CARGANDO‚Ä¶';
            const r2 = await fetch(ep,{ method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ ...payload, style:'full' })});
            const d2 = await r2.json(); ans.innerHTML = d2.answer || answer; more.remove();
          };
          cites.appendChild(document.createElement('br'));
          cites.appendChild(more);
        }

      }catch(err){
        await typewriter(ans,'‚ö†Ô∏è Error: '+(err.message||String(err)));
      }finally{
        askBtn.disabled=false; askBtn.textContent='HADOUKEN!';
      }
    }
    askBtn.addEventListener('click', ask);
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) ask(); });
  </script>
</body>
</html>
